package com.github.cunvoas.geoserviceisochrone.extern.ign.isochrone.client;

import java.io.IOException;

import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.stereotype.Component;

import com.github.cunvoas.geoserviceisochrone.model.Coordinate;

import lombok.extern.slf4j.Slf4j;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;

/**
 * @author cus
 * @see https://geoservices.ign.fr/documentation/services/api-et-services-ogc/isochrone/api
 */
@Component
@Slf4j
@ConditionalOnProperty(
		name="application.feature-flipping.isochrone-impl", 
		havingValue="ign-api-v1")
public class ClientIsoChroneApiV1 implements IsoChroneClientService {
	
	private static final String URL = "https://wxs.ign.fr/calcul/geoportail/isochrone/rest/1.0.0/";
	
	/*
	 *  
	 * curl 'https://wxs.ign.fr/calcul/geoportail/isochrone/rest/1.0.0/isochrone?
	 * 		point=2.337306%2C48.849319&costValue=300
	 * 		&resource=bdtopo-iso&distanceUnit=meter&costType=time&profile=pedestrian&direction=departure&geometryFormat=geojson&timeUnit=second&crs=EPSG%3A4326
	 * 		&constraints=%7B%22constraintType%22%3A%22banned%22%2C%22key%22%3A%22wayType%22%2C%22operator%22%3A%22%3D%22%2C%22value%22%3A%22autoroute%22%7D
	 * 		' 
	 * -H 'User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0' 
	 * -H 'Accept: application/json' 
	 * -H 'Accept-Language: fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3' 
	 * -H 'Accept-Encoding: gzip, deflate, br' 
	 * -H 'Referer: https://storage.gra.cloud.ovh.net/' 
	 * -H 'Origin: https://storage.gra.cloud.ovh.net' 
	 * -H 'Connection: keep-alive' 
	 * -H 'Sec-Fetch-Dest: empty' 
	 * -H 'Sec-Fetch-Mode: cors' 
	 * -H 'Sec-Fetch-Site: cross-site'
	 * 
	 * {"point":"2.337306,48.849319","resource":"bdtopo-iso","resourceVersion":"2023-11-02","costType":"time","costValue":300,"timeUnit":"second","profile":"car","direction":"departure","crs":"EPSG:4326","geometry":{"type":"Polygon","coordinates":[[[2.327789314,48.842605645],[2.327717205,48.842592755],[2.325682611,48.843022573],[2.324900427,48.843187813],[2.324429276,48.843287346],[2.32405514,48.843466037],[2.323064517,48.84399196],[2.322905329,48.844183523],[2.323287262,48.849819286],[2.324359845,48.851704107],[2.326437664,48.853480425],[2.327336665,48.853921253],[2.327395664,48.853929877],[2.328456694,48.853752554],[2.33053692,48.853404899],[2.330889363,48.853345998],[2.330897386,48.853344307],[2.331094592,48.853294014],[2.330877537,48.853637032],[2.330862627,48.853695404],[2.330865433,48.853739182],[2.330800128,48.853778604],[2.330768125,48.85380994],[2.330673439,48.853959575],[2.330381316,48.854421225],[2.33036634,48.85446826],[2.330247458,48.8567374],[2.330340907,48.856817289],[2.330893446,48.857263224],[2.330896057,48.857261656],[2.330914811,48.857247009],[2.330943705,48.857218115],[2.330952114,48.857208526],[2.330960884,48.857197098],[2.330967969,48.857186493],[2.330974178,48.857175739],[2.330978148,48.857167689],[2.331405143,48.856979393],[2.331453941,48.856992468],[2.33160166,48.857032049],[2.331628564,48.857035357],[2.331658944,48.857034837],[2.331685719,48.85703061],[2.331987122,48.85693868],[2.331987559,48.856938545],[2.331988053,48.856938392],[2.331988489,48.856938256],[2.332038039,48.856922634],[2.332059301,48.856913],[2.332081727,48.856899392],[2.33210009,48.85688498],[2.332238574,48.856746496],[2.332269477,48.856715593],[2.332277886,48.856706005],[2.332286655,48.856694576],[2.332293741,48.856683972],[2.33229995,48.856673218],[2.332305591,48.856661779],[2.332311103,48.856648471],[2.332315203,48.856636394],[2.332327037,48.856592227],[2.332327037,48.856592227],[2.332338324,48.856550105],[2.33324527,48.85631478],[2.333292145,48.85632734],[2.332853798,48.85691079],[2.332786695,48.85689281],[2.332774187,48.856890322],[2.332759905,48.856888442],[2.332747179,48.856887608],[2.332733493,48.856887608],[2.332720766,48.856888442],[2.332706485,48.856890322],[2.332693976,48.85689281],[2.332639252,48.856907473],[2.332473924,48.856951773],[2.33245446,48.8569593],[2.332433588,48.856970067],[2.332416172,48.856981564],[2.332367167,48.857022067],[2.332363679,48.857025091],[2.332359815,48.857028606],[2.332356474,48.857031792],[2.332154501,48.857233765],[2.332139366,48.85725334],[2.3321253,48.857277297],[2.33211558,48.857300052],[2.332025461,48.857617677],[2.332021761,48.857643576],[2.332021546,48.857672919],[2.332024866,48.857698869],[2.332037071,48.857744418],[2.33199465,48.857954418],[2.331932359,48.858016709],[2.331917224,48.858036284],[2.331903158,48.858060241],[2.331897476,48.858073541],[2.332442635,48.858513519],[2.338968342,48.857476142],[2.339099242,48.85742014],[2.339181678,48.857442228],[2.339723035,48.85735617],[2.339723666,48.857355815],[2.339743306,48.857341213],[2.33997924,48.857114647],[2.339995647,48.857093925],[2.340010727,48.857068406],[2.340020965,48.857044038],[2.340051368,48.856930572],[2.340191073,48.856795325],[2.340463746,48.856622105],[2.340534786,48.856576976],[2.34054271,48.85657137],[2.340551341,48.856564594],[2.340558669,48.856558227],[2.340747885,48.856376525],[2.340753763,48.856370365],[2.3407601,48.856363115],[2.340765418,48.856356465],[2.340849665,48.856241143],[2.340861868,48.856218807],[2.340872174,48.856192167],[2.34087818,48.856167433],[2.340891348,48.856045224],[2.341287557,48.855928775],[2.341514246,48.855989516],[2.341526755,48.855992004],[2.341541037,48.855993884],[2.341553763,48.855994719],[2.341568618,48.855994719],[2.341581344,48.855993884],[2.341595626,48.855992004],[2.341608134,48.855989516],[2.341700003,48.8559649],[2.341884034,48.855915589],[2.341896111,48.855911489],[2.34190942,48.855905977],[2.341920858,48.855900336],[2.341933722,48.855892908],[2.341944327,48.855885823],[2.341955755,48.855877054],[2.341965343,48.855868645],[2.342152195,48.855681794],[2.343250038,48.855007679],[2.34340621,48.854965833],[2.343432366,48.854958824],[2.346047513,48.856318812],[2.346056216,48.856349398],[2.346527162,48.856274533],[2.346591398,48.856191981],[2.346560112,48.856139671],[2.346557065,48.856134897],[2.346261278,48.855699849],[2.345956208,48.855251147],[2.345944271,48.855236774],[2.344977773,48.854277273],[2.344977577,48.854277078],[2.344911615,48.854211964],[2.344909738,48.85421016],[2.344612609,48.853932115],[2.344926872,48.85390045],[2.345020432,48.853891023],[2.345097565,48.853838212],[2.345191376,48.853653755],[2.34576603,48.853437349],[2.346367195,48.853606922],[2.346408295,48.853648022],[2.346413751,48.853668384],[2.346452532,48.853723383],[2.346517705,48.853740159],[2.34712948,48.853678517],[2.347183665,48.853655098],[2.348640677,48.852388777],[2.348673936,48.852307766],[2.348672447,48.852288258],[2.348667895,48.852265355],[2.348604687,48.852072187],[2.348598999,48.852058451],[2.348591492,48.85204363],[2.348583782,48.852030918],[2.348485856,48.851894183],[2.348481973,48.85188912],[2.34847744,48.851883594],[2.348473235,48.851878796],[2.348468867,48.85187413],[2.348464356,48.851869617],[2.348459142,48.85186473],[2.348454346,48.851860522],[2.348421599,48.851833632],[2.348442564,48.851683585],[2.348521608,48.851662405],[2.348533199,48.851658505],[2.348545864,48.851653339],[2.348556875,48.851648019],[2.34864203,48.851600073],[2.34865313,48.851592785],[2.348664958,48.85158381],[2.348674965,48.851575082],[2.348808404,48.851441644],[2.348816813,48.851432055],[2.348825496,48.851420739],[2.348832581,48.851410135],[2.348839391,48.85139834],[2.348845032,48.851386902],[2.34885049,48.851373724],[2.34885459,48.851361647],[2.348908491,48.851160486],[2.348927791,48.851088457],[2.348930279,48.851075948],[2.348932141,48.851061807],[2.348932975,48.851049081],[2.348932975,48.851044844],[2.349126607,48.850691746],[2.34912812,48.850689224],[2.349132338,48.850681406],[2.349182231,48.850577903],[2.349193744,48.85055402],[2.349198519,48.850542194],[2.349200086,48.850537436],[2.349265192,48.850388813],[2.349530644,48.850306431],[2.349533528,48.850306083],[2.349546063,48.85030373],[2.349559256,48.850300347],[2.349571376,48.850296378],[2.349584612,48.850291062],[2.349596111,48.850285545],[2.349673886,48.850241754],[2.349673886,48.850241754],[2.349700967,48.850226506],[2.349719334,48.850216164],[2.349719923,48.85021578],[2.349967845,48.850234474],[2.349975039,48.850240783],[2.349986354,48.850249466],[2.349996959,48.850256551],[2.350008753,48.850263361],[2.350020192,48.850269002],[2.35003337,48.85027446],[2.350045447,48.85027856],[2.350318637,48.850351761],[2.350331145,48.850354249],[2.350345287,48.850356111],[2.350358013,48.850356945],[2.350371632,48.850356945],[2.350384359,48.850356111],[2.3503985,48.850354249],[2.350411009,48.850351761],[2.350547604,48.850315161],[2.350684199,48.85027856],[2.350696276,48.85027446],[2.350709453,48.850269002],[2.350720892,48.850263361],[2.350732687,48.850256551],[2.350743291,48.850249466],[2.350754607,48.850240783],[2.350764195,48.850232374],[2.350881492,48.850115078],[2.350923769,48.850072801],[2.351240072,48.850019982],[2.351257606,48.850032583],[2.351259239,48.850033393],[2.351366558,48.850019655],[2.351427365,48.849966806],[2.351452199,48.849945222],[2.351762721,48.849546162],[2.351544396,48.848873537],[2.351443345,48.848900614],[2.351431268,48.848904714],[2.35141809,48.848910172],[2.351406651,48.848915813],[2.351402923,48.848917966],[2.350572712,48.848478853],[2.350557648,48.848410141],[2.35055494,48.848400289],[2.350551335,48.848389437],[2.350547611,48.848379923],[2.35054309,48.848369947],[2.350538391,48.848360874],[2.350532607,48.84835101],[2.350526984,48.848342479],[2.350526725,48.848342128],[2.350526588,48.848341714],[2.350521792,48.848329896],[2.350515575,48.848317058],[2.350509277,48.848305968],[2.350501792,48.84829459],[2.350494101,48.848284416],[2.350484774,48.848273625],[2.35047582,48.848264543],[2.350457573,48.848248307],[2.350443081,48.848228646],[2.350434859,48.848218897],[2.35042497,48.848208618],[2.350415545,48.848200025],[2.350404902,48.848191527],[2.350394437,48.848184238],[2.350382225,48.848176869],[2.350370898,48.848171008],[2.350370497,48.848170833],[2.350370171,48.848170543],[2.350365268,48.84816646],[2.350359629,48.848162068],[2.350354469,48.848158315],[2.350348786,48.848154458],[2.350343392,48.84815105],[2.350337229,48.848147432],[2.350331624,48.848144385],[2.350174081,48.848065284],[2.350103496,48.848029845],[2.349858995,48.847907084],[2.349857515,48.847906356],[2.349855849,48.847905555],[2.349854357,48.847904853],[2.34985274,48.847904108],[2.349851236,48.847903431],[2.349849545,48.847902687],[2.34984803,48.847902035],[2.349813972,48.84788773],[2.349812447,48.847887105],[2.349810733,48.847886418],[2.349809198,48.847885819],[2.349807535,48.847885186],[2.349805987,48.847884611],[2.349804248,48.847883982],[2.34980269,48.847883434],[2.349632426,48.847825115],[2.350435228,48.846621368],[2.350543284,48.846650322],[2.350555793,48.84665281],[2.350569934,48.846654672],[2.350582661,48.846655506],[2.35059628,48.846655506],[2.350609007,48.846654672],[2.350623148,48.84665281],[2.350635657,48.846650322],[2.350798814,48.846606604],[2.350807505,48.846603301],[2.350589471,48.845931573],[2.350385429,48.845681368],[2.35019192,48.845554617],[2.349222367,48.844919548],[2.349176817,48.844903927],[2.347176947,48.84474188],[2.346642178,48.844698548],[2.346621391,48.844699088],[2.346093896,48.844769565],[2.345953096,48.844788376],[2.345899029,48.844814165],[2.345739351,48.84496511],[2.345601778,48.844904848],[2.345572282,48.844863729],[2.345505279,48.844848208],[2.344894773,48.844929775],[2.344883742,48.844931902],[2.344372092,48.845061516],[2.344268524,48.845087752],[2.344203933,48.845141425],[2.344185769,48.845180798],[2.343699508,48.845232901],[2.343685953,48.845235332],[2.342652802,48.845497055],[2.342624175,48.845509456],[2.342169128,48.845800778],[2.341291002,48.846362957],[2.341768337,48.845812241],[2.342820828,48.84459795],[2.342919039,48.844484641],[2.342942197,48.844432155],[2.342931831,48.84437573],[2.342729878,48.843988108],[2.342726746,48.843982549],[2.342719418,48.843970482],[2.342715929,48.843965139],[2.342711208,48.843958402],[2.342707377,48.843953299],[2.342698536,48.843942291],[2.34269438,48.84393745],[2.342633827,48.843871414],[2.342650185,48.843874742],[2.342662822,48.843876463],[2.342690931,48.84387843],[2.342703684,48.843878486],[2.342719968,48.843877491],[2.342732619,48.843875882],[2.342760279,48.843870507],[2.342772613,48.843867261],[2.343037542,48.843778631],[2.343049347,48.843773803],[2.343074673,48.843761452],[2.343085746,48.843755124],[2.34309935,48.843746121],[2.343109503,48.843738401],[2.343130769,48.843719916],[2.343139827,48.843710938],[2.343324949,48.843501718],[2.343329018,48.843496804],[2.343337663,48.84348564],[2.343341402,48.84348047],[2.343346003,48.843473649],[2.343349396,48.843468246],[2.343356509,48.843456051],[2.343359541,48.843450438],[2.343433393,48.843302333],[2.343932067,48.843237775],[2.343960491,48.843244828],[2.344022167,48.843211929],[2.344455326,48.84271218],[2.344461895,48.8427037],[2.344879287,48.84209889],[2.344896276,48.842036332],[2.34489392,48.842030947],[2.344895106,48.842030801],[2.344848658,48.841655045],[2.34524684,48.841365213],[2.345350587,48.841355079],[2.345421355,48.84131342],[2.345543103,48.841137004],[2.346063991,48.840382224],[2.345999826,48.840303542],[2.344473064,48.840029584],[2.344056536,48.84002941],[2.343765888,48.839951531],[2.34375221,48.839948897],[2.343721667,48.83994525],[2.343707754,48.839944591],[2.343596059,48.83994729],[2.343585497,48.839948121],[2.343562282,48.839951224],[2.343551873,48.839953196],[2.342968485,48.840096937],[2.342943917,48.84010668],[2.342893416,48.84013516],[2.342872367,48.840151143],[2.342649054,48.840374455],[2.342498708,48.840524802],[2.342490299,48.84053439],[2.342473146,48.840556745],[2.34246606,48.840567349],[2.342457903,48.840581477],[2.342452262,48.840592915],[2.342441479,48.840618948],[2.34243738,48.840631025],[2.342436298,48.840635063],[2.340440065,48.840782586],[2.340433804,48.840779976],[2.340375271,48.840682185],[2.340364273,48.840667248],[2.340337013,48.84063678],[2.340323386,48.840624196],[2.340176942,48.840512782],[2.340171266,48.840508775],[2.340158401,48.840500363],[2.340152455,48.84049677],[2.340067505,48.840449493],[2.340055979,48.840444033],[2.34002978,48.840433662],[2.34001764,48.840429753],[2.340004518,48.840426458],[2.339991971,48.840424167],[2.339963981,48.84042093],[2.339951243,48.840420296],[2.339671916,48.840424698],[2.339665542,48.840425008],[2.339651469,48.840426153],[2.33964513,48.840426878],[2.33963838,48.840427876],[2.339632102,48.840429014],[2.339618301,48.840431986],[2.339612111,48.840433533],[2.339507546,48.840463324],[2.339423411,48.840487295],[2.339205464,48.840549391],[2.339085821,48.840583478],[2.338827628,48.840657041],[2.338779385,48.840670786],[2.338775572,48.840671872],[2.337913303,48.840507673],[2.337903739,48.84049065],[2.337844131,48.840384547],[2.33783717,48.840373861],[2.33782028,48.840351306],[2.337811984,48.840341619],[2.33780253,48.84033194],[2.337793041,48.840323419],[2.337770889,48.840306005],[2.337770579,48.840305792],[2.337724901,48.840229444],[2.337795828,48.840208692],[2.33780189,48.840206701],[2.337815151,48.840201859],[2.33782107,48.840199476],[2.337827312,48.840196721],[2.337833063,48.840193956],[2.33784558,48.840187424],[2.337851137,48.840184288],[2.338089818,48.840039118],[2.338100258,48.840031792],[2.338122214,48.840014133],[2.338131609,48.840005507],[2.338140955,48.839995724],[2.338149143,48.839985946],[2.338165781,48.839963205],[2.338172622,48.839952442],[2.338306741,48.83970738],[2.338312119,48.839695816],[2.338322305,48.839669544],[2.338326128,48.839657376],[2.33832933,48.83964423],[2.338331532,48.839631668],[2.338334571,48.839603656],[2.338335114,48.839590914],[2.338328734,48.839311625],[2.338327609,48.839298921],[2.338323294,48.839271077],[2.338320521,48.839258628],[2.338316722,48.839245642],[2.338312347,48.839233662],[2.338300972,48.839207883],[2.338295072,48.839196576],[2.338184512,48.839014799],[2.33817364,48.839000195],[2.338146775,48.838970382],[2.338133379,48.838958055],[2.338076437,48.838914734],[2.338070472,48.838910539],[2.338056938,48.838901757],[2.338050677,48.838898019],[2.33799399,48.838866996],[2.336619952,48.838620442],[2.335856288,48.838849525],[2.335874988,48.839379983],[2.33555524,48.839770835],[2.335551363,48.839775903],[2.335543157,48.839787393],[2.33553962,48.839792703],[2.335536026,48.839798504],[2.335532845,48.839804033],[2.33553141,48.839806729],[2.335520263,48.839819609],[2.335512566,48.839829778],[2.335510477,48.839832949],[2.335509108,48.839834975],[2.335507127,48.839838035],[2.335505122,48.839841079],[2.335504695,48.839841734],[2.335503756,48.839843185],[2.335503335,48.83984384],[2.335500878,48.839847705],[2.335494916,48.839858542],[2.335483287,48.839883274],[2.335478745,48.839894779],[2.335460812,48.839950275],[2.335431437,48.840000658],[2.335425748,48.840012072],[2.335414855,48.840038058],[2.335410704,48.840050117],[2.335407146,48.840063172],[2.335404605,48.84007567],[2.335403061,48.840087028],[2.335399492,48.840097921],[2.335396322,48.840110274],[2.335393853,48.840123409],[2.335393776,48.840123823],[2.335393549,48.840125065],[2.335393423,48.840125765],[2.335393396,48.84012592],[2.335393294,48.840126507],[2.335393074,48.840127804],[2.335392977,48.840128389],[2.335390821,48.840141587],[2.335389593,48.840154274],[2.335388962,48.84017454],[2.335388472,48.840177092],[2.335387635,48.840180406],[2.335386272,48.840186662],[2.33538504,48.840193373],[2.335384093,48.840199683],[2.335382456,48.840213707],[2.335381924,48.840220065],[2.335372227,48.840410964],[2.335087215,48.84069146],[2.335012735,48.840711417],[2.334914629,48.840737705],[2.334752294,48.840781202],[2.334075349,48.840542886],[2.333745187,48.840212724],[2.333735598,48.840204315],[2.333713244,48.840187162],[2.33370264,48.840180076],[2.333690922,48.840173311],[2.333679484,48.84016767],[2.333653451,48.840156887],[2.333641374,48.840152787],[2.333101689,48.840008179],[2.33308918,48.840005691],[2.333061244,48.840002013],[2.333048518,48.840001179],[2.333034988,48.840001179],[2.333022261,48.840002013],[2.332994325,48.840005691],[2.332981816,48.840008179],[2.332549166,48.840124107],[2.33230115,48.840136707],[2.332215409,48.840113733],[2.331912515,48.840032573],[2.330114995,48.840571791],[2.329888769,48.840679838],[2.328370512,48.84239087],[2.32834629,48.842463825],[2.328382455,48.842531656],[2.330984894,48.844617987],[2.330777051,48.844487102],[2.329061313,48.843406657],[2.327789314,48.842605645]]]},"constraints":[{"type":"banned","key":"waytype","operator":"=","value":"autoroute"}]}
	 * 
	 * 
	 * point=2.337306%2C48.849319&costValue=300&resource=bdtopo-iso&costType=time&profile=pedestrian&direction=departure&geometryFormat=geojson&distanceUnit=meter&timeUnit=second&crs=EPSG%3A4326
	 */
	@Override
	public String getIsoChrone(Coordinate coordinate, String duration) {
		String strResp = null;
		
		OkHttpClient client = new OkHttpClient().newBuilder().build();
		StringBuilder sb = new StringBuilder(URL);
		sb.append("/isochrone?point=");
		sb.append(coordinate.getLongitude());
		sb.append("%2C");
		sb.append(coordinate.getLatitude()); //50.62485026020619
		sb.append("&costValue=");
		sb.append(duration);
		//resource=bdtopo-pgr
		//resource=bdtopo-iso
		sb.append("&resource=bdtopo-pgr&distanceUnit=meter&costType=time&profile=pedestrian&direction=departure&geometryFormat=geojson&timeUnit=second&crs=EPSG%3A4326");
//		sb.append("&constraints=%7B%22constraintType%22%3A%22banned%22%2C%22key%22%3A%22wayType%22%2C%22operator%22%3A%22%3D%22%2C%22value%22%3A%22autoroute%22%7D");
		
		log.debug(sb.toString());;
		
		Request request = new Request.Builder()
				  .url(sb.toString())
				  .get()
				  .addHeader("accept", "application/json")
				  .addHeader("authority", "wxs.ign.fr")
				  .addHeader("accept-language", "fr-FR,fr")
//				  .addHeader("sec-ch-ua-mobile", "?0")
//				  .addHeader("sec-ch-ua-platform", "Linux")
				  .addHeader("sec-fetch-dest", "empty")
				  .addHeader("sec-fetch-mode", "cors")
				  .addHeader("sec-fetch-site", "cross-site")
				  .addHeader("Referer", "https://storage.gra.cloud.ovh.net/")
				  .addHeader("Origin", "https://storage.gra.cloud.ovh.net/")
				  
//				  .addHeader("Referrer-Policy", "strict-origin-when-cross-origin")
//				  .addHeader("user-agent", "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36")
				  .build();
		
		try {
			
			Response response = client.newCall(request).execute();
			log.debug(response.headers().toString());
			
			strResp= response.body().string();	
		} catch (IOException e) {
			e.printStackTrace();
		}
		
		return strResp;
	}

}
