<!DOCTYPE html>
<html lang="fr" 
    xmlns:th= "http://www.thymeleaf.org" 
    xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
    <head th:replace="~{fragments/fragment-head :: head(#{communautecommune.title})}"></head>
    
    <body class="sb-nav-fixed">
        <div th:insert="~{fragments/fragment-navUp :: navUp}"></div>
        <div id="layoutSidenav">
            <div th:insert="~{fragments/fragment-navLeft :: navLeft}"></div>

            <div id="layoutSidenav_content" >
 <!-- debut MAIN -->
                <main>


  <div class="container">
     <div class="col-lg-7">
     
            <div class="container-fluid px-4">
                   <h3 class="mt-4" th:text="#{communautecommune.title}">title</h3>
            </div>
           
            <!-- Message de succès -->
            <div class="row" th:if="${successMessage}">
                <div class="col-12">
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Succès !</strong> <span th:text="${successMessage}">Message</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            </div>
           
            <div class="row">
                <form th:action="@{/mvc/management/comm2co/edit}" th:object="${editCommunauteCommune}" method="post">
                
                
                    <div class="form-floating mb-3">
                            <div class="form-floating">
                                <input class="form-control" required="required" id="name" name="name"  type="text" th:attr="placeholder=#{communautecommune.name.placeholder}"  th:field="*{name}" />
                                <label for="name" th:text="#{communautecommune.name}">name</label>
                                <input id="id" name="id" type="hidden" th:field="*{id}" />
                            </div>
                    </div>
                
                    <div class="form-floating mb-3">
                            <div class="form-floating">
                                <select class="form-select" id="region.id" name="region.id" th:field="*{region.id}" th:disabled="${isAdmin == false}">
                                    <option value="" th:text="#{communautecommune.region.placeholder}">Choisir une région</option>
                                    <option th:each="region : ${regions}" 
                                        th:value="${region.id}" 
                                        th:text="${region.name}"></option>
                                </select>
                                <!-- Champ caché pour non-admin car les champs disabled ne sont pas envoyés -->
                                <input type="hidden" th:if="${isAdmin == false}" th:name="region.id" th:value="*{region.id}" />
                                <label for="region.id" th:text="#{communautecommune.region}">Région</label>
                            </div>
                    </div>
                    
                    <div class="mt-4 mb-0">
                        <div class="d-grid">
                            <input class="btn btn-primary btn-block" type="submit" th:value="#{communautecommune.submit}"/>
                        </div>
                    </div>
                </form>
                
                <!-- Bouton de calcul des surfaces -->
                <div class="row mt-3" th:if="${editCommunauteCommune.id != null}">
                    <div class="col-12">
                        <sec:authorize access="hasRole('ADMINISTRATOR')">
                            <button id="btnCompute" onclick="requestCompute()" type="button" class="btn btn-outline-secondary" th:text="#{communautecommune.compute}">Calculer</button>
                            <div id="computeSpinner" class="spinner-border text-success" role="status" style="display:none;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </sec:authorize>
                    </div>
                </div>
            </div>

        
     </div>
  </div>
                </main>
 <!-- fin MAIN -->
               
               <div th:insert="~{fragments/fragment-footer :: footer}"></div> 
            </div>
            
        </div>
        <div th:insert="~{fragments/fragment-jslibs :: appPage}"></div>

        <script th:src="@{/mvc/static/js/scripts.js}"></script>
        
        <script th:inline="javascript">
        /*<![CDATA[*/
        async function doPost(requestPrms) {
            const payload = {
                token: [[${token}]],
                com2coId: requestPrms
            };
        
            let rawResponse = await fetch([[@{/mvc/ajax/jobs/api/request}]], {
                method: "POST", 
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            // Masquer le spinner
            document.getElementById("computeSpinner").style = "display:none;";
            const objBtnCompute = document.getElementById("btnCompute");
            objBtnCompute.classList.remove('btn-secondary');
            objBtnCompute.classList.add('btn-outline-secondary');
            
            if ( rawResponse.status == 202 || rawResponse.status == 200 )  {
                const content = await rawResponse.json();
                alert("Calcul demandé pour " + content.nbCarre + " carrés.");
            }
        }
        
        function requestCompute() {
            console.log("requestCompute");
            if (document.getElementById("id").value === "" ) {
                console.log("requestCompute hasError");
                return;
            } else {
                console.log("requestCompute no hasError");
                
                // Afficher le spinner
                document.getElementById("computeSpinner").style = "display:inline-block;";
                const objBtnCompute = document.getElementById("btnCompute");
                objBtnCompute.classList.remove('btn-outline-secondary');
                objBtnCompute.classList.add('btn-secondary');
                
                // async call controler compute
                this.doPost(document.getElementById("id").value);
            }
        }
        /*]]>*/
        </script>
    </body>
</html>
