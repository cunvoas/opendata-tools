<!DOCTYPE html>
<html lang="fr" 
    xmlns:th="http://www.thymeleaf.org" 
    xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
    <head th:replace="~{fragments/fragment-head :: head(#{cityassociation.edit.title})}"></head>
    
    <body class="sb-nav-fixed">
        <div th:insert="~{fragments/fragment-navUp :: navUp}"></div>
        <div id="layoutSidenav">
            <div th:insert="~{fragments/fragment-navLeft :: navLeft}"></div>

            <div id="layoutSidenav_content">
 <!-- debut MAIN -->
                <main>

  <div class="container">
     <div class="col-lg-10">
     
            <div class="container-fluid px-4">
                <!-- Header Section -->
                <div class="row mb-4 mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="mb-1" th:text="#{cityassociation.edit.title}">Gestion des associations Villes - Communauté</h1>
                                <p class="text-muted mb-0">Gérez l'association entre villes et communautés de communes</p>
                            </div>
                            <div class="text-end" th:if="${selectedCommunaute != null}">
                                <small class="text-muted">
                                    <i class="fas fa-check-circle text-success me-1"></i>
                                    <span th:text="${'Associées: ' + (associatedCities != null ? associatedCities.size() : 0)}"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Messages de succès/erreur -->
            <div class="row" th:if="${successMessage}">
                <div class="col-12">
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>Succès !</strong> <span th:text="${successMessage}">Message</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            </div>
            <div class="row" th:if="${warningMessage}">
                <div class="col-12">
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <strong>Attention !</strong> <span th:text="${warningMessage}">Message</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            </div>
            <div class="row" th:if="${errorMessage}">
                <div class="col-12">
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Erreur !</strong> <span th:text="${errorMessage}">Message</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            </div>
            
            <!-- Détails des résultats de l'upload -->
            <div class="row" th:if="${uploadResult != null}">
                <div class="col-12">
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-info-circle me-1"></i>
                            Détails de l'import CSV
                        </div>
                        <div class="card-body">
                            <div th:if="${!uploadResult.errorList.isEmpty()}" class="mb-3">
                                <h6 class="text-danger">Erreurs :</h6>
                                <ul class="small">
                                    <li th:each="error : ${uploadResult.errorList}" th:text="${error}">Erreur</li>
                                </ul>
                            </div>
                            <div th:if="${!uploadResult.notFoundList.isEmpty()}" class="mb-3">
                                <h6 class="text-warning">Codes INSEE non trouvés :</h6>
                                <p class="small" th:text="${#strings.listJoin(uploadResult.notFoundList, ', ')}">Liste</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
           
            <!-- Filtre par région -->
            <div class="row mb-4" th:if="${isAdmin}">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Region Filter -->
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center h-100">
                                        <form th:action="@{/mvc/management/cityassoc/edit}" method="get" class="w-100">
                                            <div class="form-floating mb-0">
                                                <select class="form-select" id="regionId" name="regionId" 
                                                        onchange="this.form.submit()">
                                                    <option value="" th:text="#{cityassociation.filter.allregions}">Toutes les régions</option>
                                                    <option th:each="region : ${regions}" 
                                                            th:value="${region.id}" 
                                                            th:text="${region.name}"
                                                            th:selected="${selectedRegionId != null && selectedRegionId == region.id}"></option>
                                                </select>
                                                <label for="regionId"><i class="fas fa-map me-2"></i><span th:text="#{cityassociation.edit.region}">Région</span></label>
                                            </div>
                                            <input type="hidden" name="communauteCommuneId" th:value="${selectedCommunaute != null ? selectedCommunaute.id : ''}" />
                                        </form>
                                    </div>
                                </div>
                                
                                <!-- Communauté Filter -->
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center h-100">
                                        <form th:action="@{/mvc/management/cityassoc/edit}" method="get" class="w-100">
                                            <fieldset id="fsCommune" disabled="disabled">
                                                <div class="form-floating mb-0">
                                                    <select class="form-select" id="communauteCommuneId" name="communauteCommuneId" 
                                                            onchange="this.form.submit()">
                                                        <option value="" th:text="#{cityassociation.edit.choose}">-- Choisir --</option>
                                                        <option th:each="comm2co : ${communautes}" 
                                                                th:value="${comm2co.id}" 
                                                                th:text="${comm2co.name}"
                                                                th:attr="data-region-id=${comm2co.region != null ? comm2co.region.id : ''}"
                                                                th:selected="${selectedCommunaute != null && selectedCommunaute.id == comm2co.id}">
                                                            Communauté
                                                        </option>
                                                    </select>
                                                    <label for="communauteCommuneId"><i class="fas fa-building me-2"></i><span th:text="#{cityassociation.edit.community}">Communauté de communes</span></label>
                                                </div>
                                                <input type="hidden" name="regionId" th:value="${selectedRegionId}" />
                                            </fieldset>
                                        </form>
                                    </div>
                                </div>
                            </div>
            </div>
            
            <!-- Titre pour les non-admin -->
            <div class="row mb-4" th:if="${!isAdmin && selectedCommunaute != null}">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-gradient text-white">
                            <i class="fas fa-building me-1"></i>
                            <span th:text="${selectedCommunaute.name}">Communauté</span>
                            <span class="float-end">
                                <a th:href="@{'https://www.google.com/search?q=wiki ' + ${selectedCommunaute.name}}" 
                                   target="_blank" 
                                   class="btn btn-sm btn-outline-light"
                                   th:title="'Rechercher sur Google : wiki ' + ${selectedCommunaute.name}">
                                    <i class="fas fa-search me-1"></i>
                                    Wiki
                                </a>
                            </span>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">
                                <i class="fas fa-info-circle me-1 text-info"></i>
                                <em>Vous consultez les villes de votre communauté de communes</em>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row" th:if="${selectedCommunaute != null}">
                <!-- Villes déjà associées -->
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-gradient text-white py-3">
                            <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i><span th:text="#{cityassociation.edit.associatedcities}">Villes associées</span>
                                <span class="badge bg-light text-dark ms-2" th:text="${associatedCities != null ? associatedCities.size() : 0}">0</span>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div th:if="${associatedCities == null || associatedCities.isEmpty()}" class="text-muted p-3">
                                <i class="fas fa-inbox me-2"></i>
                                <txt th:text="#{cityassociation.edit.nocities}">Aucune ville associée</txt>
                            </div>
                            <div th:if="${associatedCities != null && !associatedCities.isEmpty()}" class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th th:text="#{cityassociation.edit.cityname}">Ville</th>
                                            <th th:text="#{cityassociation.edit.postalcode}">Code Postal</th>
                                            <th th:text="#{cityassociation.edit.action}">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="city : ${associatedCities}" class="align-middle">
                                            <td th:text="${city.name}">Ville</td>
                                            <td><span class="badge bg-light text-dark" th:text="${city.postalCode}">Code</span></td>
                                            <td>
                                                <form th:if="${!readOnly}" th:action="@{/mvc/management/cityassoc/dissociate}" method="post" style="display: inline;">
                                                    <input type="hidden" name="cityId" th:value="${city.id}" />
                                                    <input type="hidden" name="communauteCommuneId" th:value="${selectedCommunaute.id}" />
                                                    <input type="hidden" name="regionId" th:value="${selectedRegionId}" />
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" th:text="#{cityassociation.edit.remove}">
                                                        Retirer
                                                    </button>
                                                </form>
                                                <span th:if="${readOnly}" class="text-muted">-</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Villes disponibles -->
                <div class="col-lg-6" th:if="${!readOnly}">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-gradient text-white py-3">
                            <div class="d-flex justify-content-between align-items-center gap-2">
                                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i><span th:text="#{cityassociation.edit.availablecities}">Villes disponibles</span></h5>
                                <input type="text" class="form-control form-control-sm" id="searchCity" style="max-width: 250px;" th:placeholder="#{cityassociation.edit.search}" placeholder="Rechercher..." onkeyup="filterCities()" />
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0" id="availableCitiesTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th th:text="#{cityassociation.edit.cityname}">Ville</th>
                                            <th th:text="#{cityassociation.edit.postalcode}">Code Postal</th>
                                            <th th:text="#{cityassociation.edit.action}">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="city : ${allCities}" 
                                            th:if="${city.communauteCommune == null || city.communauteCommune.id != selectedCommunaute.id}"
                                            class="city-row align-middle">
                                            <td class="city-name" th:text="${city.name}">Ville</td>
                                            <td class="city-postal"><span class="badge bg-light text-dark" th:text="${city.postalCode}">Code</span></td>
                                            <td>
                                                <form th:action="@{/mvc/management/cityassoc/associate}" method="post" style="display: inline;">
                                                    <input type="hidden" name="cityId" th:value="${city.id}" />
                                                    <input type="hidden" name="communauteCommuneId" th:value="${selectedCommunaute.id}" />
                                                    <input type="hidden" name="regionId" th:value="${selectedRegionId}" />
                                                    <button type="submit" class="btn btn-sm btn-outline-success" th:text="#{cityassociation.edit.add}">
                                                        Ajouter
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section d'upload CSV -->
            <div class="row mb-4" th:if="${selectedCommunaute != null && !readOnly}">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-gradient text-white py-3">
                            <h5 class="mb-0"><i class="fas fa-file-upload me-2"></i><span th:text="#{cityassociation.edit.csvupload}">Import CSV rapide</span></h5>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/mvc/management/cityassoc/uploadCsv}" method="post" enctype="multipart/form-data">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-8">
                                        <div class="form-floating">
                                            <input class="form-control" type="file" id="csvFile" name="file" accept=".csv" required />
                                            <label for="csvFile"><i class="fas fa-paperclip me-2"></i><span th:text="#{cityassociation.edit.csvfile}">Fichier CSV :</span></label>
                                        </div>
                                        <div class="form-text small" th:text="#{cityassociation.edit.csvhelp}">
                                            Format : un code INSEE (5 chiffres) par ligne. Première ligne ignorée si elle contient "insee" ou "code".
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-upload me-1"></i>
                                            <txt th:text="#{cityassociation.edit.csvsubmit}">Importer</txt>
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" name="communauteCommuneId" th:value="${selectedCommunaute.id}" />
                                <input type="hidden" name="regionId" th:value="${selectedRegionId}" />
                            </form>
                            
                            <!-- Exemple de format CSV -->
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#csvExample" aria-expanded="false" aria-controls="csvExample">
                                    <i class="fas fa-question-circle me-1"></i>
                                    <txt th:text="#{cityassociation.edit.csvexample}">Voir exemple</txt>
                                </button>
                                <div class="collapse mt-2" id="csvExample">
                                    <div class="card card-body bg-light border-start border-4 border-info">
                                        <small>
                                            <strong>Exemple de fichier CSV :</strong><br/>
                                            <code class="font-monospace">
                                                code_insee<br/>
                                                59001<br/>
                                                59002<br/>
                                                59350<br/>
                                                59512
                                            </code>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4" th:if="${selectedCommunaute != null}">
                <div class="col-12">
                    <a th:if="${isAdmin}" th:href="@{/mvc/management/cityassoc/list}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>
                        <txt th:text="#{cityassociation.edit.back}">Retour à la liste</txt>
                    </a>
                    <span th:if="${readOnly}" class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Mode consultation uniquement
                    </span>
                </div>
            </div>

     </div>
  </div>
                </main>
 <!-- fin MAIN -->
               
               <div th:insert="~{fragments/fragment-footer :: footer}"></div> 
            </div>
            
        </div>
        <div th:insert="~{fragments/fragment-jslibs :: appPage}"></div>

        <script th:src="@{/mvc/static/js/scripts.js}"></script>
        <script>
            function filterCities() {
                const searchInput = document.getElementById('searchCity');
                const filter = searchInput.value.toLowerCase();
                const table = document.getElementById('availableCitiesTable');
                const rows = table.getElementsByClassName('city-row');
                
                for (let i = 0; i < rows.length; i++) {
                    const nameCell = rows[i].getElementsByClassName('city-name')[0];
                    const postalCell = rows[i].getElementsByClassName('city-postal')[0];
                    
                    if (nameCell && postalCell) {
                        const nameText = nameCell.textContent || nameCell.innerText;
                        const postalText = postalCell.textContent || postalCell.innerText;
                        
                        if (nameText.toLowerCase().indexOf(filter) > -1 || postalText.indexOf(filter) > -1) {
                            rows[i].style.display = '';
                        } else {
                            rows[i].style.display = 'none';
                        }
                    }
                }
            }
            
            // Manage disabled state for communauté select based on region selection
            document.addEventListener('DOMContentLoaded', function() {
                manageDisabled();
                syncRegionWithCommunaute();
            });
            
            function syncRegionWithCommunaute() {
                const communauteSelect = document.getElementById("communauteCommuneId");
                const regionSelect = document.getElementById("regionId");
                
                if (communauteSelect && regionSelect && communauteSelect.value !== "") {
                    // Get the region ID from the selected communauté option
                    const selectedOption = communauteSelect.options[communauteSelect.selectedIndex];
                    const regionId = selectedOption.getAttribute('data-region-id');
                    
                    if (regionId) {
                        regionSelect.value = regionId;
                    }
                }
            }
            
            function manageDisabled() {
                const regionSelect = document.getElementById("regionId");
                const fsCommune = document.getElementById("fsCommune");
                const communauteSelect = document.getElementById("communauteCommuneId");
                
                if (regionSelect && fsCommune) {
                    if (regionSelect.value !== "" || (communauteSelect && communauteSelect.value !== "")) {
                        fsCommune.disabled = false;
                    }
                }
            }
            
            // Listen for changes to enable/disable based on region
            const regionSelect = document.getElementById("regionId");
            if (regionSelect) {
                regionSelect.addEventListener('change', manageDisabled);
            }
            
            const communauteSelect = document.getElementById("communauteCommuneId");
            if (communauteSelect) {
                communauteSelect.addEventListener('change', syncRegionWithCommunaute);
            }
        </script>
        
        <style>
            /* Custom styles for enhanced design */
            .bg-gradient {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .card {
                transition: all 0.3s ease;
            }
            
            .card:hover {
                box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important;
            }
            
            .table-hover tbody tr:hover {
                background-color: rgba(102, 126, 234, 0.05);
            }
            
            .form-label {
                font-weight: 600;
                color: #495057;
            }
            
            .form-floating > label {
                color: #6c757d;
            }
            
            .badge {
                font-weight: 500;
                padding: 0.4rem 0.6rem;
            }
            
            /* Smooth transitions for form elements */
            .form-select, .form-control {
                transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            }
            
            .form-select:focus, .form-control:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            }
            
            /* Header styling */
            h1 {
                color: #2c3e50;
                font-weight: 700;
            }
            
            /* Table styling improvements */
            .table-light th {
                border-bottom: 2px solid #dee2e6;
                font-weight: 600;
                color: #495057;
            }
            
            .text-muted.small {
                font-size: 0.85rem;
            }
            
            .font-monospace {
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            }
            
            .sticky-top {
                position: sticky;
                top: 0;
                z-index: 10;
            }
            
            fieldset:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
            
            fieldset:disabled .form-select {
                background-color: #e9ecef;
            }
            
            /* Align table columns for both city lists */
            .table thead th {
                width: 33.333%;
            }
            
            .table thead th:first-child {
                width: 45%;
            }
            
            .table thead th:nth-child(2) {
                width: 30%;
            }
            
            .table thead th:nth-child(3) {
                width: 25%;
                text-align: center;
            }
            
            .table tbody td:nth-child(3) {
                text-align: center;
            }
        </style>
    </body>
</html>
